$(".modal").modal('hide');
$('#content').html("<%= j render 'form', army: @army %>");
$('#armyModal').modal('show');

$('.remove_unit').on('click', function() {
  var id = $(this).attr('id').split("_")[1]
  $('#unit_fields_' + id).remove();
});

$('.damage_unit').on('click', function () {
  const box = $(this).siblings('.damage_box').first();
  // Hide all other damage_box elements
  $('.damage_box').not(box).addClass('d-none');
  // Toggle the clicked one
  box.toggleClass('d-none');
});

$('#armyModal').on('click', function (e) {
  if (!$(e.target).hasClass('damage')) {
    $('.damage_box').addClass('d-none');
  }
});

$('.damage_apply').on('click', function () {
  const box = $(this).closest('.damage_box')
  var damage_field = $(this).siblings('.damage_field').first()
  var damage = (Number(damage_field.val()) || 0) * <%= @army_scale %>;
  var hp_per_unit = Number($(this).siblings('.hp_per_unit').first().html());
  var count_field = $(this).siblings('.unit_count').first();
  var count_start = Number($(this).siblings('.count_start').first().html());
  var casualties = Math.min(parseInt(damage / hp_per_unit), count_start);
  var death_visible = $(this).closest('.unit_fields').find('.count_death');
  var casualties_box = $(this).closest('.unit_fields').find('.casualties');
  var count_new = (count_start - casualties)
  count_field.val(count_new);
  death_visible.html(casualties);
  casualties_box.removeClass('d-none');

  if (casualties > 0) {
    box.addClass('d-none');
  } else {
    casualties_box.addClass('d-none');
  }
});
