$(document).on('turbolinks:load', function () {
  if ($(".armies").length !== 0) {
    // Trigger armies load for master
    $('.armies-load').click(function() {
      $('#spinner-main').removeClass('d-none');

      if ($(this).hasClass('master')) {
        if ($(this).hasClass('active')) {
          $('.armies-tab').removeClass('active')
        } else {
          $('.armies-tab').addClass('active')
        }
      } else {
        $(this).toggleClass('active');
      }

      if ($('.armies-tab:not(.master):not(.active)').length > 0) {
        $('.master').removeClass('active')
      } else {
        $('.master').addClass('active')
      }

      const factions = $('.armies-tab.active').map(function() {
        const id = $(this).attr('id');
        return id ? id.split('-')[1] : null;
      }).get();

      const visibility = $('.visible-tab.active').map(function() {
        const id = $(this).attr('id');
        return id ? id.split('-')[1] : null;
      }).get();

      $('#active_factions').val(JSON.stringify(factions));
      $('#active_visibility').val(JSON.stringify(visibility));

      // Submit the form
      const form = $(this).closest('form');
      form.submit();
    });

    $.fn.copyArmies = function() {
      $('.mass-copy').click(function() {
        var checkboxGroup = $(this).data("checkbox");
        let message = "";
        let str = 0;
        let men = 0;
        let ind = 0;
        let hp = 0;

        // Loop through all checked CheckBoxes in GridView.
      $(`.checkbox_selectable:visible:checked[data-checkbox='${checkboxGroup}']`).each(function () {
            let row = $(this).closest("tr");
            if (row.hasClass("tablesorter-headerRow") == false) {
              message += "> * " + row.find('.' + checkboxGroup + '_copy').text().replace(/(\r\n|\n|\r)/gm, " ").replace(/\s+/g, " ").trim();
              message += "\n";
              str += parseFloat(row.find('.' + checkboxGroup + '_strength').text())
              men += parseInt(row.find('.' + checkboxGroup + '_men').text())
              ind += parseFloat(row.find('.' + checkboxGroup + '_strength_indirect').text())
              hp += parseInt(row.find('.' + checkboxGroup + '_hp').text())
            }
        });

        message += "Total: 🎖️: " + str.toFixed(2) + " 𖦏: " + ind.toFixed(2) + " ❤︎: " + hp + " 🪖: " + men

        navigator.clipboard.writeText(message)
      });
    }

    $.fn.copyArmies();
    $.fn.inline_listeners();
  }
});
