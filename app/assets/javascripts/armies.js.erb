// Copy selected to clipboard
$(document).on('turbolinks:load', function () {

    $(function () {
        //Assign Click event to Button.
        $(".copy").click(function () {
            var message = "";

            //Loop through all checked CheckBoxes in GridView.
            $("input[type=checkbox]:visible:checked").each(function () {
                var row = $(this).closest("tr")[0];
                if ($(this).closest("tr")[0].id != "table_title") {
                  message += row.cells[2].textContent; // Army name
                  message += " (" + row.cells[3].textContent + ")"; // Army status
                  if (row.cells[4].textContent != "") message += ", en " + row.cells[4].textContent; // Army position
                  if (row.cells[5].textContent != "") {

                    var stringArray = $.trim(row.cells[5].textContent).split(/\n/)

                    var resultArray = [];
                    for (var i = 0; i < stringArray.length; i++) {
                      var element = $.trim(stringArray[i]); // Remove leading and trailing whitespace from each element
                      if (element) { // Skip empty elements
                        resultArray.push(element);
                      }
                    }

                    message += " [" + resultArray.join(", ") + "]"; // Army tratis
                  }

                  message += " FUE: " + row.cells[1].textContent
                  message += "\n";
                };
            });

            // Create a dummy input to copy the string array inside it
            var dummy = document.createElement("textarea");
            // Add it to the document
            document.body.appendChild(dummy);
            // Output the array into it
            dummy.value = message;
            // Select it
            dummy.select();
            // Copy its contents
            document.execCommand("copy");
            // Remove it as its not needed anymore
            document.body.removeChild(dummy);
        });
    });
});

// Filters
$.fn.armyFilters = function(house){
    var value = $("#filtertext-" + house).val().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    var column = $("#filterselect-" + house).children("option:selected").val();
    $("#army_list").filterTable(value, column);
    var countArmies = $('input[type="checkbox"]:visible').length - 1;
    $("#count-visible").html(countArmies);
}

// Recalculate stats
$.fn.recalculateStats = function(){
    var countArmies = $('input[type="checkbox"]:visible').length - 1;
    $("#count-visible").html(countArmies);

    var countStrenght = 0;
    $('.strenght:visible').each(function(){
        countStrenght += parseFloat($(this).text());  // Or this.innerHTML, this.innerText
    });
    $("#count-visible-strenght").html(countStrenght);
}


// Trigger filters
$(document).on('turbolinks:load', function(){
    var houses = <%= ["master"] %>;

    $.each( houses, function( k, house ) {

        $("#filterselect-" + house).on("change", function() {
            $.fn.armyFilters(house) // Why I need to remove the semicolons!!!!!
            $.fn.recalculateStats()
        });
        $("#filtertext-" + house).on("keyup", function() {
            $.fn.armyFilters(house)
            $.fn.recalculateStats()
        });
    });
});

// Trigger recalculate stats on changing tabs
$(document).on('turbolinks:load', function(){
    $('a[data-toggle="tab"]').on('shown.bs.tab', function () {
        $.fn.recalculateStats()
    })
});

// Add hidden checkboxes for mass edit options
$(document).on('turbolinks:load', function(){
  $('.checkbox_selectable').change(function() {
    var form = $('#edit_multiple');
    var armyId = $(this).val();

    if ($(this).is(':checked')) {
      // If the checkbox is checked, add the army_id to the form parameters
      $('<input>').attr({
        type: 'hidden',
        name: 'army_ids[]',
        value: armyId
      }).appendTo(form);
    } else {
      // If the checkbox is unchecked, remove the corresponding input element from the form
      form.find('input[value="' + armyId + '"]').remove();
    }
  });
});
