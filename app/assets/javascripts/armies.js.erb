// Change from land to sea
$(document).on('turbolinks:load', function () {
  if ($(".armies").length !== 0 ) {

    // activate the right tabs  // Get the URL hash (e.g., #tab2)
    const urlHash = window.location.hash;

    // If there's a hash in the URL
    if (urlHash) {
      // Activate the tab with the matching ID
      $(urlHash + '-tab').click();
    }

    // Copy selected to clipboard
    $(function () {
        //Assign Click event to Button.
        $(".mass-copy").click(function () {
            var message = "";

            //Loop through all checked CheckBoxes in GridView.
            $("input[type=checkbox]:visible:checked").each(function () {
                var row = $(this).closest("tr");
                if ($(this).closest("tr")[0].id != "table_title") {
                  message += "> * ";
                  message += row[0].cells[2].textContent;
                  message += " (" + row[0].cells[3].textContent + ")"
                  if (row.find(".inline-edit-input").val() != "") message += ", en " + row.find(".inline-edit-input").val();
                  if (row[0].cells[6].textContent.trim().split(" ").slice(-1)[0] != "agrupar") message += " grupo " + row[0].cells[6].textContent.trim().split(" ").slice(-1)[0].toUpperCase();
                  if (row[0].cells[4].textContent.trim() != "") message += " [" + row[0].cells[4].textContent.trim().replace(/\s{2,}/g, ', ') + "]";
                  message += " FUE: " + row[0].cells[1].textContent.trim();
                  message += "\n";
                };
            });

            // Create a dummy input to copy the string array inside it
            var dummy = document.createElement("textarea");
            // Add it to the document
            document.body.appendChild(dummy);
            // Output the array into it
            dummy.value = message;
            // Select it
            dummy.select();
            // Copy its contents
            document.execCommand("copy");
            // Remove it as its not needed anymore
            document.body.removeChild(dummy);
        });
    });

    // Recalculate stats
    $.fn.recalculateStats = function(){
        var faction = $('#myTabs .active').attr('id').split("-tab")[0];
        var men_per_army = parseInt($('#men_per_army').text());
        var men_per_step = parseInt($('#men_per_step').text());
        var countArmies = $('input[type="checkbox"]:visible').length - 1;
        var menArmies = 0
        $('.army-hp:visible').each(function(){
            menArmies += parseInt($(this).text().trim().split(" ")[1].replace(/â€“/g, '-'));  // Or this.innerHTML, this.innerText
        });
        var strArmies = 0
        $('.strenght:visible').each(function(){
            strArmies += parseFloat($(this).text());  // Or this.innerHTML, this.innerText
        });

        $("#" + faction + "_count").html(countArmies);
        $("#" + faction + "_str").html(strArmies);
        $("#" + faction + "_men").html((countArmies * men_per_army) + (menArmies * men_per_step));
    }

    $.fn.recalculateStats()

    // Filters
    $.fn.armyFilters = function(){
        var value = $("#filtertext").val().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        var column = $("#filterselect").children("option:selected").val();
        $(".army_list").filterTable(value, column);
        var countArmies = $('input[type="checkbox"]:visible').length - 1;
        $("#count-visible").html(countArmies);
    }

    // Trigger filters
    $("#filterselect").on("change", function() {
        $.fn.armyFilters() // Why I need to remove the semicolons!!!!!
        $.fn.recalculateStats()
    });
    $("#filtertext").on("keyup", function() {
        $.fn.armyFilters()
        $.fn.recalculateStats()
    });

    // Trigger recalculate stats on changing tabs
    $(document).on('shown.bs.tab', function (e) {
        $.fn.recalculateStats()
    })

    // Add hidden checkboxes for mass edit options
    $('.checkbox_selectable').change(function() {
      var form = $('#edit_multiple');
      var armyId = $(this).val();

      if ($(this).is(':checked')) {
        // If the checkbox is checked, add the army_id to the form parameters
        $('<input>').attr({
          type: 'hidden',
          name: 'army_ids[]',
          value: armyId
        }).appendTo(form);
      } else {
        // If the checkbox is unchecked, remove the corresponding input element from the form
        form.find('input[value="' + armyId + '"]').remove();
      }
    });
  }
});
