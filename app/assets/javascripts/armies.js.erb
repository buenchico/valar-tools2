$(document).on('turbolinks:load', function () {
  if ($(".armies").length !== 0) {
    // Trigger table filterSelect
    $.fn.tableFiltersLoad();

    $.fn.recalculateStats = function() {
      let totalMen = 0;
      let totalStr = 0;
      const groupedTotals = {};

      $('.unit_count').each(function () {
        const $row = $(this).closest('tr');
        if (!$row.is(':visible')) return;

        const classes = $(this).attr('class')?.split(/\s+/) || [];
        const typeClass = classes.find(c => c !== 'unit_count' && c !== 'd-none');
        if (!typeClass) return;

        const value = parseFloat($(this).text()) || 0;
        groupedTotals[typeClass] = (groupedTotals[typeClass] || 0) + value;
      });

      $('.units_visible').addClass('d-none');

      Object.entries(groupedTotals).forEach(([key, value]) => {
        const cell = $('#' + key + '_visible');
        cell.html(value.toLocaleString('fr-FR'));
        cell.parent().removeClass('d-none');
      });

      $('.unit_men').each(function () {
        const $row = $(this).closest('tr');
        if (!$row.is(':visible')) return;

        const value = parseInt($(this).text()) || 0;
        totalMen += value;
      });
      $('#men_visible').html(totalMen.toLocaleString('fr-FR'));

      $('.unit_strength').each(function () {
        const $row = $(this).closest('tr');
        if (!$row.is(':visible')) return;

        const value = parseFloat($(this).text()) || 0;
        totalStr += value;
      });
      $('#strength_visible').html(totalStr.toLocaleString('fr-FR'));
    };

    // recalculate stats on filter
    $(".filterSelect").on("change", function() {
        const filterGroup = $(this).data("filter");
        $.fn.recalculateStats();
    });
    $(".filterText").on("keyup", function() {
        const filterGroup = $(this).data("filter");
        $.fn.recalculateStats();
    });

    $.fn.recalculateStats();

    // Trigger armies load for master
    $('.armies-load').click(function() {
      $('#spinner-main').removeClass('d-none');

      if ($(this).hasClass('master')) {
        if ($(this).hasClass('active')) {
          $('.armies-tab').removeClass('active')
        } else {
          $('.armies-tab').addClass('active')
        }
      } else {
        $(this).toggleClass('active');
      }

      if ($('.armies-tab:not(.master):not(.active)').length > 0) {
        $('.master').removeClass('active')
      } else {
        $('.master').addClass('active')
      }

      const factions = $('.armies-tab.active').map(function() {
        const id = $(this).attr('id');
        return id ? id.split('-')[1] : null;
      }).get();

      const visibility = $('.visible-tab.active').map(function() {
        const id = $(this).attr('id');
        return id ? id.split('-')[1] : null;
      }).get();

      $('#active_factions').val(JSON.stringify(factions));
      $('#active_visibility').val(JSON.stringify(visibility));

      // Submit the form
      const form = $(this).closest('form');
      form.submit();
    });

    $.fn.copyArmies = function() {
      $('.mass-copy').click(function() {
        const button = $(this); // capture reference
        var checkboxGroup = button.data("checkbox");
        let message = "";
        let str = 0;
        let men = 0;
        let ind = 0;
        let hp = 0;
        let size = 0;
        let speed = 0;
        let speed_text = ""

        // Loop through all checked CheckBoxes in GridView.
      $(`.checkbox_selectable:visible:checked[data-checkbox='${checkboxGroup}']`).each(function () {
            let row = $(this).closest("tr");
            if (row.hasClass("tablesorter-headerRow") == false) {
              message += "> * " + row.find('.' + checkboxGroup + '_copy').text().replace(/(\r\n|\n|\r)/gm, " ").replace(/\s+/g, " ").trim();
              message += "\n";
              str += parseFloat(row.find('.' + checkboxGroup + '_strength').text())
              men += parseInt(row.find('.' + checkboxGroup + '_men').text())
              ind += parseFloat(row.find('.' + checkboxGroup + '_strength_indirect').text())
              hp += parseInt(row.find('.' + checkboxGroup + '_hp').text())
              row_speed = parseFloat(row.find('.' + checkboxGroup + '_speed').data('speed'))
              if (row_speed > speed) {
                speed = row_speed
                speed_text = row.find('.' + checkboxGroup + '_speed').text().trim();
              }
              size += parseInt(row.find('.' + checkboxGroup + '_size').text())
            }
        });

        message += "Total: 🎖️: " + str.toFixed(2) + " 𖦏: " + ind.toFixed(2) + " ❤︎: " + hp + " 🪖: " + men + " #: " + size + " 🏃‍♂️‍: " + speed_text

        navigator.clipboard.writeText(message)

        button.addClass('bg-success-subtle text-dark');
        button.find('.bi-check').removeClass('d-none');
        setTimeout(function() {
          button.removeClass('bg-success-subtle text-dark');
          button.find('.bi-check').addClass('d-none');
        }, 500);
      });
    }

    $.fn.copyArmies();
    $.fn.inline_listeners();
  }
});
